# 变量处理修复测试

## 🔧 修复内容

### 问题描述
- 用户点击提示词选择"插入到编辑器"时，系统变量（如 `{{filename}}`、`{{selection}}`、`{{filepath}}`）没有被正确替换
- 原因：变量处理时序问题，在复制到剪贴板时使用原始内容，而不是在实际插入时处理变量

### 修复方案
1. **延迟变量处理**：不在复制到剪贴板时预处理变量
2. **实时处理**：在用户选择具体操作（粘贴到聊天/插入到编辑器）时才进行变量处理
3. **系统变量优先**：确保 `insertPrompt` 方法总是先处理系统变量，再处理自定义变量

### 修改的文件
- `src/extension.ts`: 修复 `promptManager.selectPrompt` 命令的变量处理逻辑
- `src/promptManager.ts`: 修复 `insertPrompt` 方法，确保总是处理系统变量

## 🧪 测试步骤

### 测试用例 1：系统变量测试
创建包含以下内容的提示词：
```
# 代码分析助手

请分析以下代码：

## 文件信息
- 文件名：{{filename}}
- 文件路径：{{filepath}}

## 选中的代码
{{selection}}

## 分析要求
请提供详细的代码分析和改进建议。
```

### 测试步骤
1. 在 VS Code 中打开任意代码文件
2. 选中一段代码
3. 使用命令面板执行 "Prompt Manager: Select Prompt"
4. 选择上述测试提示词
5. 点击 "Insert to Editor"
6. 验证：
   - `{{filename}}` 应该被替换为实际文件名
   - `{{filepath}}` 应该被替换为实际文件路径  
   - `{{selection}}` 应该被替换为选中的代码内容

### 预期结果
所有系统变量都应该被正确替换为实际值，而不是显示原始的占位符。

### 测试用例 2：聊天粘贴测试
使用相同的测试提示词：
1. 执行相同的前 4 步
2. 选择 "Paste in Chat" 而不是 "Insert to Editor"
3. 粘贴到聊天窗口
4. 验证变量是否也被正确处理

## 🎯 修复验证

修复后的行为：
- ✅ 系统变量在插入编辑器时被正确替换
- ✅ 系统变量在粘贴到聊天时被正确替换  
- ✅ 提供变量处理状态反馈（显示处理了多少个变量）
- ✅ 错误处理和降级机制
- ✅ 保持向后兼容性

修复前的问题：
- ❌ 系统变量显示为原始占位符（如 `{{filename}}`）
- ❌ 没有实时变量处理
- ❌ 缺少错误处理 